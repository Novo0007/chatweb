<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime Chat + Voice/Video Calls (Firebase RTDB) â€” Debugged</title>
  <style>
    :root[data-theme="dark"] { 
      --bg: #0f1115; 
      --card: #161a22; 
      --muted: #222735; 
      --text: #e6e8ef; 
      --sub: #9aa3b2; 
      --pri: #4f8cff; 
      --ok: #22c55e; 
      --warn: #f59e0b; 
      --err: #ef4444;
      --red: #ff4444;
      --green: #4caf50;
      --border: #22293a;
      --input-bg: #101522;
      --hover: #1b2231;
    }

    :root[data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #f1f5f9;
      --text: #1e293b;
      --sub: #64748b;
      --pri: #3b82f6;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --red: #ef4444;
      --green: #22c55e;
      --border: #e2e8f0;
      --input-bg: #f8fafc;
      --hover: #f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0f1115,#10131a);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    a{color:var(--pri)}
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:rgba(22,26,34,.95);backdrop-filter: blur(12px);border-bottom:1px solid #22293a;position:sticky;top:0;z-index:3}
    header #headerMenuBtn{display:none}
    header .brand{font-weight:700}
    header .pill{background:var(--muted);padding:6px 10px;border-radius:999px;color:var(--sub)}
    header .sp{flex:1}
    .shell{display:grid;grid-template-columns:300px 1fr;gap:0;height:calc(100vh - 120px)}
    @media (max-width: 900px){
      .shell{grid-template-columns:1fr}
      .sidebar{position:fixed;left:-100%;top:0;bottom:0;width:85%;max-width:300px;z-index:100;transition:0.3s ease-in-out}
      .sidebar.show{left:0}
      .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99}
      .sidebar-overlay.show{display:block}
      .room-head .menu-btn{display:block}
      header #headerMenuBtn{display:inline-block !important;}
    }
    .sidebar{border-right:1px solid #22293a;background:var(--card);display:flex;flex-direction:column;box-shadow:0 0 20px rgba(0,0,0,0.2)}
    .me{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #22293a}
    .avatar{width:40px;height:40px;border-radius:50%;background:#334155;display:grid;place-items:center;font-weight:700}
    .rooms{padding:12px;overflow:auto}
    .rooms button{display:flex;width:100%;align-items:center;gap:12px;background:transparent;border:0;text-align:left;padding:12px;border-radius:12px;color:var(--text);cursor:pointer;transition:0.2s}
    .rooms button:hover,.rooms button.active{background:#1b2231;transform:translateX(4px)}
    .composer{display:flex;gap:10px;padding:16px;border-top:1px solid #22293a;background:rgba(22,26,34,.95);backdrop-filter:blur(12px)}
    .composer {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      border-top: 1px solid #22293a;
      background: rgba(22,26,34,.95);
      backdrop-filter: blur(12px);
      position: fixed;
      left: 0;
      right: 0;
      bottom: 56px; /* leave space for call controls/footer */
      z-index: 20;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
    }
    .composer input[type=text]{flex:1;background:#101522;border:1px solid #283147;color:var(--text);padding:14px;border-radius:12px;font-size:15px}
    .main {
      position: relative;
      min-height: 0;
      padding-bottom: 80px; /* space for composer and call controls */
    }
  .composer input[type=file]{display:none}
  .composer .btn{background:var(--pri);border:1px solid var(--pri);color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;transition:0.2s;font-weight:600;}
  .composer .btn:hover{background:var(--hover);color:var(--pri);border-color:var(--pri)}
  .composer .send-req{background:var(--ok);border:1px solid var(--ok);color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;margin-right:8px;}
  .composer .send-req:hover{background:var(--hover);color:var(--ok);border-color:var(--ok)}
    .msgs{overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
    .msg{display:flex;gap:12px;max-width:85%}
    .msg.mine{margin-left:auto;flex-direction:row-reverse}
    .msg .bubble{background:#1b2231;padding:12px 16px;border-radius:18px;border-top-left-radius:4px}
    .msg.mine .bubble{background:var(--pri);border-top-left-radius:18px;border-top-right-radius:4px}
    .msg .meta-line{font-size:12px;color:var(--sub);margin-top:4px}
    .msg .attach {
      display:block;
      max-width:220px;
      max-height:160px;
      border-radius:10px;
      margin-top:8px;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      transition:0.2s;
    }
    .msg .attach:hover {
      box-shadow:0 4px 16px rgba(0,0,0,0.18);
      transform:scale(1.04);
    }
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;place-items:center;z-index:100}
    .modal.show{display:grid}
    .call{background:var(--card);border:1px solid #22293a;border-radius:24px;padding:24px;width:min(980px,96vw);box-shadow:0 8px 32px rgba(0,0,0,0.2)}
    .call-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .call-title{font-size:18px;font-weight:600}
    .call-status{color:var(--sub);font-size:14px}
    .videos-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;margin-bottom:20px}
    .video-container{position:relative;border-radius:16px;overflow:hidden;background:#000;aspect-ratio:16/9}
    .video-container video{width:100%;height:100%;object-fit:cover}
    .video-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);opacity:0;transition:0.3s}
    .video-container:hover .video-overlay{opacity:1}
    .call-controls{display:flex;gap:12px;justify-content:center}
    .call-btn{padding:12px 24px;border-radius:999px;border:0;color:#fff;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;transition:0.2s}
    .call-btn:hover{transform:translateY(-2px)}
    .call-btn.end{background:var(--red)}
    .call-btn.accept{background:var(--green)}
    .call-btn.decline{background:var(--red)}
    .incoming-call{position:fixed;top:24px;right:24px;background:var(--card);border:1px solid #22293a;border-radius:16px;padding:16px;z-index:1000;display:none;animation:slideIn 0.3s ease-out}
    .incoming-call.show{display:block}
    .incoming-call-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .incoming-call-avatar{width:48px;height:48px;border-radius:50%;background:#334155;display:grid;place-items:center;font-weight:700}
    .incoming-call-info{flex:1}
    .incoming-call-name{font-weight:600;margin-bottom:4px}
    .incoming-call-type{color:var(--sub);font-size:13px}
    .incoming-call-controls{display:flex;gap:8px}
    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }
    .banner{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #22293a;color:#e5e7eb;padding:12px 20px;border-radius:16px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .banner.show{display:block;animation:fadeIn 0.3s ease-out}
    @keyframes fadeIn{
      from{transform:translate(-50%, 20px);opacity:0}
      to{transform:translate(-50%, 0);opacity:1}
    }

    /* Auth styles */
    .auth-form {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      width: min(400px, 90vw);
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
    }

    .auth-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .auth-header h2 {
      margin: 0;
      color: var(--text);
      font-size: 24px;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--sub);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      border-radius: 8px;
      color: var(--text);
      font-size: 15px;
      transition: 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--pri);
      box-shadow: 0 0 0 2px var(--pri-10);
    }

    .auth-submit {
      width: 100%;
      padding: 12px;
      background: var(--pri);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .auth-submit:hover {
      filter: brightness(1.1);
    }

    .auth-switch {
      text-align: center;
      margin-top: 16px;
      color: var(--sub);
    }

    .auth-switch span {
      cursor: pointer;
      color: var(--pri);
    }

    /* App-like improvements */
    .tools.button {
      background: var(--muted);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
    }

    .tools.button:hover {
      background: var(--hover);
    }

    .tools.button.icon-btn {
      padding: 8px 10px;
      line-height: 1;
    }

    .sidebar {
      background: var(--card);
      border-right: 1px solid var(--border);
    }

    .rooms button {
      padding: 12px 16px;
      border-radius: 12px;
      transition: 0.2s;
    }

    .rooms button:hover {
      background: var(--hover);
    }

    .msg .bubble {
      background: var(--muted);
      border: 1px solid var(--border);
    }

    .msg.mine .bubble {
      background: var(--pri);
      border: none;
    }

    /* Add smooth transitions for theme changes */
    * {
      transition: background-color 0.3s, border-color 0.3s, color 0.3s;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button id="headerMenuBtn" class="tools button icon-btn" style="display:none;margin-right:8px">â˜°</button>
      <div class="brand">ðŸ’¬ ChatApp</div>
      <span class="pill" id="authState">Signed out</span>
      <span class="sp"></span>
      <button id="themeToggle" class="tools button icon-btn">ðŸŒ™</button>
      <button id="btnSignIn" class="tools button">Sign in</button>
      <button id="btnSignUp" class="tools button">Sign up</button>
      <button id="btnSignOut" class="tools button" style="display:none">Sign out</button>
    </header>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
      <div class="auth-form">
        <div class="auth-header">
          <h2 id="authTitle">Sign in</h2>
          <button class="close-btn" id="closeAuth">Ã—</button>
        </div>
        <form id="authForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" required placeholder="Enter your email">
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter your password">
          </div>
          <div id="nameField" class="form-group" style="display:none">
            <label for="displayName">Display Name</label>
            <input type="text" id="displayName" placeholder="Enter your name">
          </div>
          <button type="submit" id="authSubmit" class="auth-submit">Sign in</button>
          <p class="auth-switch">
            <span id="authSwitch">Don't have an account? Sign up</span>
          </p>
        </form>
      </div>
    </div>

    <div class="shell">
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
      <aside class="sidebar" id="sidebar">
        <div class="me">
          <div class="avatar" id="meAvatar">?</div>
          <div>
            <div id="meName">Guest</div>
            <div class="presence" id="mePresence">offline</div>
          </div>
        </div>
        <div class="tools" style="padding:16px;display:flex;gap:10px;border-bottom:1px solid #22293a">
          <input id="newRoomName" placeholder="New room name" style="flex:1;background:#101522;border:1px solid #283147;color:#e5e7eb;padding:12px;border-radius:12px;font-size:15px" />
          <button id="createRoom" class="btn" style="padding:12px 20px">Create</button>
        </div>
        <div class="rooms" id="rooms"></div>
      </aside>

      <main class="main" style="display:grid;grid-template-rows:auto auto 1fr auto;background:radial-gradient(1200px 600px at 70% -10%, rgba(79,140,255,.06), transparent), var(--bg)">
        <div class="room-head" style="display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid #22293a">
          <button class="menu-btn btn" id="menuBtn" style="display:none;padding:8px">â˜°</button>
          <div class="avatar" id="roomAvatar">#</div>
          <div style="flex:1">
            <div id="roomTitle">No room selected</div>
            <div class="presence" id="roomPresence">â€”</div>
            <div class="online-count" id="onlineCount" style="font-size:13px;color:var(--ok);margin-top:2px"></div>
          </div>
          <button id="btnVoice" class="btn" style="display:flex;align-items:center;gap:6px">
            <span>ðŸ“ž</span> Voice Call
          </button>
          <button id="btnVideo" class="btn" style="display:flex;align-items:center;gap:6px">
            <span>ðŸ“¹</span> Video Call
          </button>
        </div>

        <div class="typing" id="typing" style="padding:4px 16px;color:var(--sub);font-size:13px"></div>
        <div class="msgs" id="msgs"></div>

        <div class="composer">
          <label class="btn" for="file" style="padding:14px;margin-right:8px">ðŸ“Ž</label>
          <input id="file" type="file" accept="image/*" />
          <input id="message" type="text" placeholder="Type a messageâ€¦" style="margin-right:8px" />
          <button id="send" class="btn" style="min-width:120px">Send Message</button>
        </div>
      </main>
    </div>

    <footer style="padding:12px 20px;color:var(--sub);border-top:1px solid #22293a;background:var(--card)">
      Built with Firebase Realtime Database, Auth, and WebRTC
    </footer>
  </div>

  <div class="modal" id="callModal">
        <div class="me">
          <div class="avatar" id="meAvatar">?</div>
          <div>
            <div id="meName">Guest</div>
            <div class="presence" id="mePresence">offline</div>
          </div>
        </div>
        <div class="tools" style="padding:16px;display:flex;gap:10px;border-bottom:1px solid #22293a">
          <input id="newRoomName" placeholder="New room name" style="flex:1;background:#101522;border:1px solid #283147;color:#e5e7eb;padding:12px;border-radius:12px;font-size:15px" />
          <button id="createRoom" class="btn" style="padding:12px 20px">Create</button>
        </div>
        <div class="users-list" id="usersList" style="padding:16px 12px;border-bottom:1px solid #22293a;background:var(--muted);">
          <div style="font-weight:600;color:var(--pri);margin-bottom:8px;font-size:16px;letter-spacing:0.5px">All Users <span id="userCount" style="color:var(--ok);font-size:15px"></span></div>
          <input id="findFriend" type="text" placeholder="Find friend by name or email..." style="width:100%;margin-bottom:10px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);font-size:14px">
          <div id="allUsers" style="min-height:32px"></div>
        </div>
        <div class="rooms" id="rooms"></div>
    // Show all registered users in sidebar
    function showAllUsers() {
      const usersDiv = document.getElementById('allUsers');
      const userCountSpan = document.getElementById('userCount');
      if (!usersDiv) return;
      usersDiv.innerHTML = '<span style="color:var(--sub);font-size:13px">Loading...</span>';
      get(ref(db, 'users')).then(snap => {
        if (!snap.exists()) {
          usersDiv.innerHTML = '<span style="color:var(--sub);font-size:13px">No users found.</span>';
          if(userCountSpan) userCountSpan.textContent = '';
          return;
        }
        const users = snap.val();
        const userArr = Object.values(users);
        if(userCountSpan) userCountSpan.textContent = `(${userArr.length})`;

        // Filter logic
        const filterInput = document.getElementById('findFriend');
        let filter = '';
        if(filterInput) filter = filterInput.value.trim().toLowerCase();
        const filtered = filter ? userArr.filter(u => (u.displayName||'').toLowerCase().includes(filter) || (u.email||'').toLowerCase().includes(filter)) : userArr;

        usersDiv.innerHTML = filtered.map(u =>
          `<div style='display:flex;align-items:center;gap:8px;margin-bottom:6px'>
            <div style='width:28px;height:28px;border-radius:50%;background:#334155;display:grid;place-items:center;font-weight:600;color:#fff'>${(u.displayName||u.email||'U')[0].toUpperCase()}</div>
            <span style='font-size:15px;color:var(--text)'>${u.displayName||u.email}</span>
            <button class='add-friend-btn' data-uid='${u.uid}' style='margin-left:auto;padding:4px 10px;border-radius:8px;background:var(--pri);color:#fff;border:none;cursor:pointer;font-size:13px'>Add Friend</button>
          </div>`
        ).join('');
      });
    }

    // Save user info on registration
    onAuthStateChanged(auth, async (user) => {
      // ...existing code...
      showAllUsers();
      // Add event listener for find friend search
      const filterInput = document.getElementById('findFriend');
      if(filterInput) {
        filterInput.oninput = () => showAllUsers();
      }
    // Add Friend button handler (demo only, does not persist yet)
    document.addEventListener('click', function(e) {
      if(e.target && e.target.classList.contains('add-friend-btn')) {
        const uid = e.target.getAttribute('data-uid');
        if(uid) {
          banner('Friend request sent to user: ' + uid);
          // Here you can add logic to persist friend requests in DB
        }
      }
    });
      if (user) {
        // Save user info to DB if not already present
        const userRef = ref(db, `users/${user.uid}`);
        get(userRef).then(snap => {
          if (!snap.exists()) {
            set(userRef, {
              uid: user.uid,
              email: user.email,
              displayName: user.displayName || '',
              joined: Date.now()
            });
          }
        });
      }
    });
        <div class="video-container">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="video-overlay">
            <div class="video-label" id="remoteVideoLabel">Remote User</div>
          </div>
        </div>
      </div>
      <div class="call-controls">
        <button id="toggleAudio" class="call-btn">ðŸŽ¤ Mute</button>
        <button id="toggleVideo" class="call-btn">ðŸ“¹ Hide Video</button>
        <button id="endCall" class="call-btn end">End Call</button>
        <style>
          .call-controls {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(22,26,34,.98);
            box-shadow: 0 -2px 12px rgba(0,0,0,0.10);
            padding: 12px 0 12px 0;
            z-index: 30;
            justify-content: center;
          }
        </style>
      </div>
    </div>
  </div>

  <div class="incoming-call" id="incomingCall">
    <div class="incoming-call-header">
      <div class="incoming-call-avatar" id="callerAvatar">?</div>
      <div class="incoming-call-info">
        <div class="incoming-call-name" id="callerName">Unknown</div>
        <div class="incoming-call-type" id="callType">Incoming call...</div>
      </div>
    </div>
    <div class="incoming-call-controls">
      <button id="acceptCall" class="call-btn accept">Accept</button>
      <button id="declineCall" class="call-btn decline">Decline</button>
    </div>
  </div>

  <div class="banner" id="banner"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, onValue, serverTimestamp, onDisconnect, remove, get, onChildChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // Initialize theme
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
    
    // Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyAnj9N2Ed0OZCb2qVAB37oPXTw7NUvPNdc",
      authDomain: "messager-57338.firebaseapp.com",
      databaseURL: "https://messager-57338-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "messager-57338",
      storageBucket: "messager-57338.firebasestorage.app",
      messagingSenderId: "659724092913",
      appId: "1:659724092913:web:1c7c3de633bdb6c39e7050",
      measurementId: "G-DE4T4X768R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => auth.currentUser?.uid;

    const els = {
      authState: $('#authState'), btnGoogle: $('#btnGoogle'), btnAnon: $('#btnAnon'), btnSignOut: $('#btnSignOut'),
      authAnonTest: $('#authAnonTest'), authGoogleTest: $('#authGoogleTest'), runTests: $('#runTests'),
      meName: $('#meName'), meAvatar: $('#meAvatar'), mePresence: $('#mePresence'),
      rooms: $('#rooms'), newRoomName: $('#newRoomName'), createRoom: $('#createRoom'),
      roomTitle: $('#roomTitle'), roomAvatar: $('#roomAvatar'), roomPresence: $('#roomPresence'),
      msgs: $('#msgs'), typing: $('#typing'), file: $('#file'), message: $('#message'), send: $('#send'),
      btnVoice: $('#btnVoice'), btnVideo: $('#btnVideo'), modal: $('#callModal'), callTitle: $('#callTitle'), localVideo: $('#localVideo'), remoteVideo: $('#remoteVideo'), endCall: $('#endCall'),
    };

    // --- State variables ---
    // currentRoomId was previously missing. Declare it upfront so any handler that references it won't throw.
    let currentRoomId = null;
    let pc = null, localStream = null, remoteStream = null, callPath = null;

    const banner = (msg, timeout=2800) => { const b = $('#banner'); b.textContent = msg; b.classList.add('show'); console.info('BANNER:', msg); setTimeout(()=>b.classList.remove('show'), timeout); };

    // Header menu button for mobile
    const headerMenuBtn = document.getElementById('headerMenuBtn');
    if(headerMenuBtn) {
      headerMenuBtn.onclick = () => {
        document.getElementById('sidebar').classList.add('show');
        document.getElementById('sidebarOverlay').classList.add('show');
      };
    }

    // Centralized handler for auth errors (including admin-restricted-operation)
    function handleAuthError(err, ctx = ''){
      console.error('Auth error', ctx, err);
      const code = (err && err.code) ? String(err.code) : String(err && err.message || err);
      if(code.includes('admin-restricted') || code.includes('ADMIN_RESTRICTED')){
        banner('Blocked: This operation is restricted to project administrators. Check Firebase Console â†’ Authentication â†’ Sign-in method and enable the provider or allow account creation (project-level setting).');
      } else if(code.includes('operation-not-allowed')){
        banner('Provider disabled in Firebase Console â†’ Authentication â†’ Sign-in method. Enable the provider to proceed.');
      } else if(code.includes('unauthorized-domain')){
        banner('Unauthorized domain: add this domain under Firebase Console â†’ Authentication â†’ Authorized domains.');
      } else if(code.includes('popup-closed-by-user')){
        banner('Popup closed by user. Try signing in again.');
      } else {
        banner('Auth error: ' + (err.message || JSON.stringify(err)));
      }
    }

    // Theme toggling
    let isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    $('#themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    
    $('#themeToggle').onclick = () => {
      isDark = !isDark;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      $('#themeToggle').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
    };

    // Auth UI handling
    let isSignUp = false;
    
    function showAuthModal(signup = false) {
      isSignUp = signup;
      $('#authTitle').textContent = isSignUp ? 'Sign up' : 'Sign in';
      $('#authSubmit').textContent = isSignUp ? 'Sign up' : 'Sign in';
      $('#authSwitch').textContent = isSignUp ? 'Already have an account? Sign in' : 'Don\'t have an account? Sign up';
      $('#nameField').style.display = isSignUp ? 'block' : 'none';
      $('#authModal').classList.add('show');
    }

    $('#btnSignIn').onclick = () => showAuthModal(false);
    $('#btnSignUp').onclick = () => showAuthModal(true);
    $('#closeAuth').onclick = () => $('#authModal').classList.remove('show');
    
    $('#authSwitch').onclick = () => {
      isSignUp = !isSignUp;
      $('#authTitle').textContent = isSignUp ? 'Sign up' : 'Sign in';
      $('#authSubmit').textContent = isSignUp ? 'Sign up' : 'Sign in';
      $('#authSwitch').textContent = isSignUp ? 'Already have an account? Sign in' : 'Don\'t have an account? Sign up';
      $('#nameField').style.display = isSignUp ? 'block' : 'none';
    };

    $('#authForm').onsubmit = async (e) => {
      e.preventDefault();
      const email = $('#email').value;
      const password = $('#password').value;
      const displayName = $('#displayName').value;

      try {
        if (isSignUp) {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          if (displayName) {
            await updateProfile(userCred.user, { displayName });
          }
          banner('Account created successfully!');
        } else {
          await signInWithEmailAndPassword(auth, email, password);
          banner('Signed in successfully!');
        }
        $('#authModal').classList.remove('show');
        $('#authForm').reset();
      } catch (e) {
        handleAuthError(e, isSignUp ? 'Sign up' : 'Sign in');
      }
    };

    els.btnSignOut.onclick = async () => {
      try {
        await signOut(auth);
        banner('Signed out');
      } catch (e) {
        console.error(e);
        banner('Sign out failed');
      }
    };

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        els.authState.textContent = 'Signed out';
        els.meName.textContent = 'Guest';
        els.meAvatar.textContent = '?';
        els.mePresence.textContent = 'offline';
        els.btnSignOut.style.display = 'none';
        $('#btnSignIn').style.display = '';
        $('#btnSignUp').style.display = '';
        return;
      }
      
      if(!user.displayName){
        try{ 
          await updateProfile(user, { 
            displayName: $('#displayName').value || 'User-'+user.uid.slice(0,4) 
          }); 
        } catch(e){ 
          console.warn('updateProfile failed:', e); 
        }
      }
      
      els.authState.textContent = 'Signed in';
      els.meName.textContent = user.displayName || 'User';
      els.meAvatar.textContent = (user.displayName||'U').slice(0,2).toUpperCase();
      els.mePresence.textContent = 'online';
      els.btnSignOut.style.display = '';
      $('#btnSignIn').style.display = 'none';
      $('#btnSignUp').style.display = 'none';

      setupPresence();
      subscribeRooms();
    });

    // Ensure the user is signed in before actions that write user-specific data
    function ensureAuth(action = 'perform this action'){
      if(uid()) return true;
      banner(`Please sign in (Google / Anonymous) to ${action}.`);
      return false;
    }

    function setupPresence(){
      if(!uid()) return;
      const statusRef = ref(db, `status/${uid()}`);
      const connectedRef = ref(db, ".info/connected");
      onValue(connectedRef, (snap)=>{
        if(snap.val() === false) return;
        onDisconnect(statusRef).set({ state:'offline', lastChanged: serverTimestamp() });
        set(statusRef, { state:'online', lastChanged: serverTimestamp() });
      });
    }

    // Rooms
    els.createRoom.onclick = async ()=>{
      if(!ensureAuth('create a room')) return;
      const name = (els.newRoomName.value || '').trim();
      if(!name) return banner('Room name required');
      try{
        const rRef = push(ref(db, 'rooms'));
        // createdBy will be UID (ensureAuth ensures user exists). If something odd happens, omit createdBy rather than writing undefined.
        const payload = { name, createdAt: serverTimestamp() };
        if(uid()) payload.createdBy = uid();
        await set(rRef, payload);
        els.newRoomName.value = '';
        banner('Room created');
        // Auto-select new room and close sidebar on mobile
        selectRoom(null, rRef.key, { name });
        if(window.innerWidth <= 900) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
      }catch(e){ console.error('createRoom failed', e); banner('Failed to create room: ' + (e.message||e)); }
    };

    function subscribeRooms(){
      els.rooms.innerHTML = '';
      const rRef = ref(db, 'rooms');
      onChildAdded(rRef, (snap)=> renderRoomItem(snap.key, snap.val()));
      // also update existing rooms changed
      onChildChanged(rRef, (snap)=>{
        // naive approach: if UI has a button for this roomId, update its label
        const roomId = snap.key; const room = snap.val(); const el = document.getElementById(`room-btn-${roomId}`);
        if(el) el.querySelector('.room-name') && (el.querySelector('.room-name').textContent = room.name || 'Room');
      });
    }

    function renderRoomItem(roomId, room){
      // create a button element for the room; id attribute helps later updates
      const btn = document.createElement('button'); btn.id = `room-btn-${roomId}`;
      const roomName = room?.name || 'Room';
      btn.innerHTML = `<div class="avatar">${String(roomName[0]||'R').toUpperCase()}</div><div style="flex:1;margin-left:8px;"><div class="room-name">${roomName}</div><div class="presence" id="presence-${roomId}">â€”</div></div><div class="meta"><div class="unread" id="unread-${roomId}" style="display:none">0</div></div>`;
      btn.onclick = (e)=> {
        selectRoom(e, roomId, room);
        // Close sidebar on mobile after selecting room
        if(window.innerWidth <= 900) {
          document.getElementById('sidebar').classList.remove('show');
          document.getElementById('sidebarOverlay').classList.remove('show');
        }
      };
      els.rooms.appendChild(btn);

      onValue(ref(db, `roomPresence/${roomId}/count`), (s)=>{
        const el = document.getElementById(`presence-${roomId}`);
        if(el) el.textContent = s.exists() ? `${s.val()} online` : 'â€”';
        if(roomId === currentRoomId) {
          const onlineCount = document.getElementById('onlineCount');
          if(onlineCount) onlineCount.textContent = s.exists() ? `${s.val()} user(s) online` : '';
        }
      });

      if(uid()){
        onValue(ref(db, `lastRead/${roomId}/${uid()}`), (s)=>{
          const lastRead = s.val() || 0;
          get(ref(db, `rooms/${roomId}/messages`)).then(messagesSnap=>{
            let unread = 0;
            messagesSnap.forEach(m=>{ if((m.val().ts||0) > lastRead) unread++; });
            const badge = document.getElementById(`unread-${roomId}`);
            if(badge){ badge.style.display = unread ? 'inline-block' : 'none'; badge.textContent = unread; }
          }).catch(e=>console.warn('count unread failed', e));
        });
      }
    }

    // selectRoom: allow event to be null (tests may call without a DOM event). Safe assignment prevents ReferenceError.
    function selectRoom(eventOrNull, roomId, room){
      currentRoomId = roomId;
      // remove active class from previous buttons
      $$('#rooms button').forEach(b=>b.classList.remove('active'));
      // if an event with a currentTarget is passed (normal flow), mark it active
      if(eventOrNull && eventOrNull.currentTarget) eventOrNull.currentTarget.classList.add('active');
      els.roomTitle.textContent = room?.name || 'Room';
      els.roomAvatar.textContent = (room?.name?.[0]||'#').toUpperCase();
      els.msgs.innerHTML = '';
      subscribeMessages(roomId);
      startTypingWatcher(roomId);
      if(uid()) set(ref(db, `lastRead/${roomId}/${uid()}`), Date.now()).catch(()=>{});
    }

    // Messages
    function subscribeMessages(roomId){
      const mRef = ref(db, `rooms/${roomId}/messages`);
      onChildAdded(mRef, (snap)=>{
        const m = snap.val(); renderMessage(m, snap.key); els.msgs.scrollTop = els.msgs.scrollHeight;
      });
    }

    function renderMessage(m){
      const mine = m.uid === uid();
      const div = document.createElement('div');
      div.className = 'msg' + (mine ? ' mine' : '');
      let imgHtml = '';
      if(m.image) {
        imgHtml = `<img class=\"attach\" src=\"${m.image}\" alt=\"attachment\" onclick=\"window.open('${m.image}','_blank')\"/>`;
      }
      div.innerHTML = `<div class=\"avatar\">${String((m.name||'??').slice(0,2)).toUpperCase()}</div><div class=\"bubble\">${m.text ? `<div>${escapeHtml(m.text)}</div>` : ''}${imgHtml}<div class=\"meta-line\"><span>${new Date(m.ts||Date.now()).toLocaleTimeString()}</span>${m.readBy? `<span>Read by ${Object.keys(m.readBy).length}</span>` : ''}</div></div>`;
      els.msgs.appendChild(div);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    let typingTimer = null;
    function startTypingWatcher(roomId){
      const tRef = ref(db, `typing/${roomId}`);
      onValue(tRef, (snap)=>{
        const val = snap.val() || {};
        if(uid()) delete val[uid()];
        const names = Object.values(val).map(v=>v.name);
        $('#typing').textContent = names.length ? `${names.join(', ')} is typingâ€¦` : '';
      });
    }

    els.message.addEventListener('input', ()=>{
      if(!currentRoomId) return;
      if(!uid()) return; // don't write typing state when not signed in
      set(ref(db, `typing/${currentRoomId}/${uid()}`), { name: auth.currentUser?.displayName || 'User', ts: Date.now() }).catch(e=>console.warn('typing write failed', e));
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=> remove(ref(db, `typing/${currentRoomId}/${uid()}`)).catch(()=>{}), 1200);
    });

    els.send.onclick = async ()=>{
      if(!currentRoomId) return banner('Pick a room first');
      if(!ensureAuth('send messages')) return;
      const text = (els.message.value || '').trim();
      let imageUrl = null;
      try{ imageUrl = await maybeUploadImage(); }catch(e){ console.warn('image upload inlined failed', e); }
      if(!text && !imageUrl) return;
      try{
        const mRef = push(ref(db, `rooms/${currentRoomId}/messages`));
        const payload = { uid: uid() || null, name: auth.currentUser?.displayName || 'User', text: text || null, image: imageUrl || null, ts: Date.now() };
        await set(mRef, payload);
        els.message.value = '';
        remove(ref(db, `typing/${currentRoomId}/${uid()}`)).catch(()=>{});
        if(uid()) set(ref(db, `lastRead/${currentRoomId}/${uid()}`), Date.now()).catch(()=>{});
      }catch(e){ console.error('send message failed', e); banner('Failed to send message: ' + (e.message||e)); }
    };

    // Send Request button handler
    document.getElementById('sendReq').onclick = async () => {
      if(!currentRoomId) return banner('Pick a room first');
      if(!ensureAuth('send messages')) return;
      try {
        const mRef = push(ref(db, `rooms/${currentRoomId}/messages`));
        const payload = { uid: uid() || null, name: auth.currentUser?.displayName || 'User', text: '[Request]', ts: Date.now() };
        await set(mRef, payload);
        banner('Request sent!');
      } catch(e) { banner('Failed to send request: ' + (e.message||e)); }
    };

    async function maybeUploadImage(){
      const f = els.file.files[0]; if(!f) return null;
      // quick inline base64 (not recommended for production)
      return await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f); });
    }

    els.msgs.addEventListener('scroll', ()=>{
      if(!currentRoomId || !uid()) return;
      if(els.msgs.scrollTop + els.msgs.clientHeight >= els.msgs.scrollHeight - 10){
        set(ref(db, `lastRead/${currentRoomId}/${uid()}`), Date.now()).catch(e=>console.warn('lastRead write failed', e));
      }
    });

    // Mobile menu handling
    $('#menuBtn').onclick = () => {
      $('#sidebar').classList.add('show');
      $('#sidebarOverlay').classList.add('show');
    };
    $('#sidebarOverlay').onclick = () => {
      $('#sidebar').classList.remove('show');
      $('#sidebarOverlay').classList.remove('show');
    };

    // Responsive layout setup
    function setupResponsive() {
      const isMobile = window.innerWidth <= 900;
      $('#menuBtn').style.display = isMobile ? 'block' : 'none';
      if (!isMobile) {
        $('#sidebar').classList.remove('show');
        $('#sidebarOverlay').classList.remove('show');
      }
    }
    window.addEventListener('resize', setupResponsive);
    setupResponsive();

    // WebRTC with enhanced controls
    let isAudioMuted = false;
    let isVideoHidden = false;

    async function startCall(video=false){
      if(!currentRoomId) return banner('Pick a room first');
      if(!ensureAuth('start a call')) return;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video });
        remoteStream = new MediaStream();
        $('#localVideo').srcObject = localStream;
        $('#remoteVideo').srcObject = remoteStream;
        $('#callModal').classList.add('show');
        $('#callStatus').textContent = 'Calling...';
        
        pc = new RTCPeerConnection({ 
          iceServers:[
            {urls:'stun:stun.l.google.com:19302'},
            {urls:'stun:stun1.l.google.com:19302'}
          ] 
        });
        
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

        const callRef = push(ref(db, `calls/${currentRoomId}`));
        const callId = callRef.key;
        callPath = `calls/${currentRoomId}/${callId}`;
        
        pc.onicecandidate = e => {
          if(e.candidate) {
            push(ref(db, `${callPath}/callerCandidates`), e.candidate.toJSON())
              .catch(e => console.warn('push ICE failed', e));
          }
        };

        pc.oniceconnectionstatechange = () => {
          const status = pc.iceConnectionState;
          $('#callStatus').textContent = {
            'checking': 'Connecting...',
            'connected': 'Connected',
            'completed': 'Connected',
            'disconnected': 'Disconnected',
            'failed': 'Connection failed',
            'closed': 'Call ended'
          }[status] || status;
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        const payload = {
          offer,
          roomId: currentRoomId,
          type: video ? 'video' : 'audio',
          from: uid(),
          fromName: auth.currentUser?.displayName || 'User',
          createdAt: serverTimestamp()
        };
        
        await set(ref(db, callPath), payload);

        onValue(ref(db, `${callPath}/answer`), async (snap) => {
          if(snap.exists() && pc.signalingState !== 'stable') {
            await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
            $('#callStatus').textContent = 'Connected';
          }
        });

        onChildAdded(ref(db, `${callPath}/calleeCandidates`), (snap) => 
          pc.addIceCandidate(new RTCIceCandidate(snap.val())));

        // Set remote video label
        onValue(ref(db, `${callPath}/answeredBy`), (snap) => {
          if(snap.exists()) {
            $('#remoteVideoLabel').textContent = snap.val().name || 'Remote User';
          }
        });

      } catch(e) {
        console.error('startCall failed', e);
        handleAuthError(e, 'startCall');
        endCall();
      }
    }

    async function answerIncoming(callId, callInfo){
      if(!ensureAuth('answer a call')) return;
      try{
        const mediaConstraints = {
          audio: true,
          video: callInfo.type === 'video'
        };

        localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        remoteStream = new MediaStream();
        
        $('#localVideo').srcObject = localStream;
        $('#remoteVideo').srcObject = remoteStream;
        $('#callModal').classList.add('show');
        $('#callStatus').textContent = 'Connecting...';
        $('#remoteVideoLabel').textContent = callInfo.fromName || 'Remote User';
        
        pc = new RTCPeerConnection({ 
          iceServers:[
            {urls:'stun:stun.l.google.com:19302'},
            {urls:'stun:stun1.l.google.com:19302'}
          ] 
        });

        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
        
        callPath = `calls/${currentRoomId}/${callId}`;

        pc.onicecandidate = e => {
          if(e.candidate) {
            push(ref(db, `${callPath}/calleeCandidates`), e.candidate.toJSON())
              .catch(e => console.warn('push callee ICE failed', e));
          }
        };

        pc.oniceconnectionstatechange = () => {
          const status = pc.iceConnectionState;
          $('#callStatus').textContent = {
            'checking': 'Connecting...',
            'connected': 'Connected',
            'completed': 'Connected',
            'disconnected': 'Disconnected',
            'failed': 'Connection failed',
            'closed': 'Call ended'
          }[status] || status;
        };

        const callSnap = await get(ref(db, callPath));
        const { offer } = callSnap.val() || {};
        
        if(!offer) return banner('Call offer not found');
        
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        
        await set(ref(db, `${callPath}/answer`), answer);
        await set(ref(db, `${callPath}/answeredBy`), {
          uid: uid(),
          name: auth.currentUser?.displayName || 'User'
        });

        onChildAdded(ref(db, `${callPath}/callerCandidates`), (snap) =>
          pc.addIceCandidate(new RTCIceCandidate(snap.val())));

        // Hide incoming call notification
        $('#incomingCall').classList.remove('show');

      } catch(e) {
        console.error('answerIncoming failed', e);
        handleAuthError(e, 'answerIncoming');
        endCall();
      }
    }

    function endCall() {
      try {
        pc?.getSenders().forEach(s => s.track?.stop());
        pc?.close();
        set(ref(db, `${callPath}/ended`), {
          at: serverTimestamp(),
          by: uid()
        }).catch(() => {});
      } catch(e) {
        console.warn('endCall cleanup error', e);
      }

      pc = null;
      localStream = null;
      remoteStream = null;
      callPath = null;
      
      $('#callModal').classList.remove('show');
      $('#incomingCall').classList.remove('show');
      $('#callStatus').textContent = '';
    }

    // Call controls
    $('#toggleAudio').onclick = () => {
      if(!localStream) return;
      const audioTrack = localStream.getAudioTracks()[0];
      if(audioTrack) {
        isAudioMuted = !isAudioMuted;
        audioTrack.enabled = !isAudioMuted;
        $('#toggleAudio').textContent = isAudioMuted ? 'ðŸ”‡ Unmute' : 'ðŸŽ¤ Mute';
      }
    };

    $('#toggleVideo').onclick = () => {
      if(!localStream) return;
      const videoTrack = localStream.getVideoTracks()[0];
      if(videoTrack) {
        isVideoHidden = !isVideoHidden;
        videoTrack.enabled = !isVideoHidden;
        $('#toggleVideo').textContent = isVideoHidden ? 'ðŸ‘ï¸ Show Video' : 'ðŸ“¹ Hide Video';
      }
    };

    $('#btnVoice').onclick = () => startCall(false);
    $('#btnVideo').onclick = () => startCall(true);
    $('#endCall').onclick = endCall;
    $('#acceptCall').onclick = () => {
      const callId = $('#acceptCall').dataset.callId;
      const callInfo = JSON.parse($('#acceptCall').dataset.callInfo);
      answerIncoming(callId, callInfo);
    };
    $('#declineCall').onclick = () => {
      const callId = $('#declineCall').dataset.callId;
      if(callId) {
        set(ref(db, `calls/${currentRoomId}/${callId}/declined`), {
          at: serverTimestamp(),
          by: uid()
        }).catch(() => {});
      }
      $('#incomingCall').classList.remove('show');
    };

    // Incoming call watcher with enhanced UI
    setInterval(async () => {
      if(!currentRoomId || !uid()) return;
      try {
        const callsSnap = await get(ref(db, `calls/${currentRoomId}`));
        if(!callsSnap.exists()) return;
        
        const entries = Object.entries(callsSnap.val());
        for(const [id, call] of entries) {
          if(!call.answer && !call.declined && call.from !== uid()) {
            // Show incoming call notification
            $('#callerName').textContent = call.fromName || 'Unknown';
            $('#callType').textContent = `Incoming ${call.type || 'voice'} call...`;
            $('#callerAvatar').textContent = (call.fromName || '?')[0].toUpperCase();
            
            // Store call info for accept/decline handlers
            $('#acceptCall').dataset.callId = id;
            $('#acceptCall').dataset.callInfo = JSON.stringify(call);
            $('#declineCall').dataset.callId = id;
            
            $('#incomingCall').classList.add('show');
            return;
          }
        }
      } catch(e) {
        console.warn('incoming call watcher err', e);
      }
    }, 3000);

    // Sanity / diagnostics tests (extended)
    function runSanityTests(){
      const results = [];
      // Basic SDK checks
      results.push({ test: 'SDK loaded', ok: !!app });
      results.push({ test: 'Auth initialized', ok: !!auth });
      results.push({ test: 'DB initialized', ok: !!db });
      // State checks
      results.push({ test: 'currentRoomId defined', ok: typeof currentRoomId !== 'undefined' });

      // Functional check: selectRoom without DOM event should set currentRoomId
      const testRoomId = 'local-test-room-' + Math.random().toString(36).slice(2,7);
      try{
        selectRoom(null, testRoomId, { name: 'Local Test Room' });
        results.push({ test: 'selectRoom sets currentRoomId', ok: currentRoomId === testRoomId });
      }catch(e){ results.push({ test: 'selectRoom sets currentRoomId', ok:false, error: String(e) }); }

      // Clean up after test
      currentRoomId = null;

      // Guard check: sending without room triggers banner early (we capture banner)
      const previousBanner = banner;
      let lastBanner = null;
      window.banner = (m, t=2800)=>{ lastBanner = m; console.info('TEST-BANNER:', m); previousBanner(m,t); };
      try{
        // call send handler synchronously (it returns a Promise but early-return will run synchronously)
        els.send.onclick();
        results.push({ test: 'send without room warns', ok: lastBanner && lastBanner.toLowerCase().includes('pick a room') });
      }catch(e){ results.push({ test: 'send without room warns', ok:false, error:String(e) }); }
      // restore
      window.banner = previousBanner;

      console.table(results);
      banner('Sanity checks completed â€” see console for details');
    }
    els.runTests.onclick = runSanityTests;

    // Helpful console guidance for common Firebase auth errors
    console.info('If you see auth/admin-restricted-operation, it means account creation or the provider is restricted in the Firebase project. Typical fixes: (1) In Firebase Console â†’ Authentication â†’ Sign-in method, enable the provider and allow account creation; (2) Add this domain to Authorized domains (if unauthorized-domain).');

  </script>
</body>
</html>
